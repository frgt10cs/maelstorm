function init(){dialogsGui.showUploading();api.getDialogs(dialogs.getDialogsStackNumber(),n=>{signalRConnection.startConnection(),dialogs.updateDialogs(dialog.createDialogs(n)),dialogsGui.hideUploading()})}function initModules(n){api.init(n);accountGui.init(loginForm,regForm);account.init(api,accountGui);dialogsGui.init();dialogGui.init(date);dialog.init(api,dialogGui,message,date,20,dialogsGui.toTheTop);dialogs.init(dialogsGui,dialog);connectionGui.init();signalRConnection.init(api,n,dialogs,connectionGui)}function main(){Fingerprint2.get(function(n){var t=n.map(function(n){return n.value}),i=Fingerprint2.x64hash128(t.join(""),31);initModules(i);api.areTokensValid()?init():accountGui.openLogin()})}var accountModule=function(){var t,n,i=function(){n.getLoginForm().isDataValid()&&t.login(n.getLoginForm().getLogin(),n.getLoginForm().getPassword(),()=>{n.onLogin(),n.hideAllForms()},()=>{onLoginFailed(),alert("Login failed")})},r=function(){n.regForm.isDataValid()&&t.registration(n.regForm.login,n.getRegForm().getEmail(),n.getRegForm().getPassword(),n.getRegForm.getPasswordConfirm(),()=>{onRegistration()},n=>{onRegistrationFailed(n)})},u=function(){t.logOut();n.openLogin()};return{init:function(f,e){t=f;n=e;n.getLoginForm().getSubmitButton().onclick=i;n.getRegForm().getSubmitButton().onclick=r;n.getLogoutBtn().onclick=u}}}(),loginFormModule=function(){var n,t,i,r;return{init:function(){n=document.getElementById("loginForm");t=document.getElementById("login");i=document.getElementById("password");r=document.getElementById("loginBtn")},getLogin:function(){return t.value},getPassword:function(){return i.value},getSubmitButton:function(){return r},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),registrationFormModule=function(){var n,t,i,r,u,f;return{init:function(){n=document.getElementById("regForm");t=document.getElementById("regLogin");i=document.getElementById("regEmail");r=document.getElementById("regPassword");u=document.getElementById("regPasswordConfirm");f=document.getElementById("regBtn")},getLogin:function(){return t.value},getEmail:function(){return i.value},getPassword:function(){return r.value},getPasswordConfirm:function(){return u.value},getSubmitButton:function(){return f},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),accountGuiModule=function(){var n,t,r,u,f,i,e=function(){i.style.display="block";n.hide();t.open()},o=function(){i.style.display="block";t.hide();n.open()};return{getLoginForm:function(){return n},getRegForm:function(){return t},getLogoutBtn:function(){return r},openLogin:o,openRegistration:e,hideAllForms:function(){i.style.display="none";n.hide();t.hide()},init:function(s,h){u=document.getElementById("openLogin");u.onclick=function(){o()};f=document.getElementById("openReg");f.onclick=function(){e()};r=document.getElementById("logoutButton");i=document.getElementById("dark");n=s;n.init();t=h;t.init()}}}(),dialogModule=function(){var u,o,t,i,r,s,n,w=function(t){n.messagesPanel.prepend(t.element)},h=function(t){n.messagesPanel.appendChild(t.element)},b=function(){var n=document.createElement("div");return n.classList.add("conversationMessages"),n.style.display="none",n.onscroll=function(){k()},n},k=function(){n.uploadingBlocked||(n.messagesPanel.scrollTop<10&&!n.allReadedUpload?(console.log("old upl"),n.uploadingBlocked=!0,a()):n.messagesPanel.scrollHeight-n.messagesPanel.scrollTop-n.messagesPanel.offsetHeight<10&&!n.allUnreadedUpload&&n.unreadedMessages.length===0&&(console.log("new upl"),n.uploadingBlocked=!0,e()))},f=function(t){return n.interlocutorId===t.authorId},c=function(t){if(t!==null&&t!==undefined&&t.length>0){t.length<i&&(n.allUnreadedUpload=!0);for(var u=0;u<t.length;u++)r.setElement(t[u],f(t[u])),h(t[u]),n.unreadedMessages.push(t[u])}else n.allUnreadedUpload=!0;n.uploadingBlocked=!1},l=function(t){var e,u;if(t!==null&&t!==undefined&&t.length>0){for(t.length<i&&(n.allReadedUpload=!0),n.readedMessagesOffset+=t.length,e=0,u=0;u<t.length;u++)r.setElement(t[u],f(t[u])),w(t[u]),n.messages.unshift(t[u]),e+=t[u].element.offsetHeight;n.messagesPanel.scrollTop=e}else n.allReadedUpload=!0;n.uploadingBlocked=!1},e=function(){u.getUnreadedMessages(n.id,i,c)},a=function(){u.getReadedMessages(n.id,n.readedMessagesOffset,i,l)},v=function(n){return n.isPanelOpened=!1,n.unreadedMessages=[],n.messages=[],n.unconfirmedMessages=[],n.readedMessagesOffset=0,n.allReadedUploaded=!1,n.allUnreadedUploaded=!1,n.uploadingBlocked=!1,n.messagesPanel=b(),n.element=t.createDialogDiv(n),n},d=function(){a()},g=function(){var i={},u;return r.setText(i,t.getMessageText()),i.targetId=n.interlocutorId,u=n.unconfirmedMessages.length,i.dateOfSending=new Date,i.status=-1,i.bindId=u,i},y=function(t){p(t);n.unconfirmedMessages.push(t);u.sendDialogMessage(t,t=>{var i=JSON.parse(t.data),r=n.unconfirmedMessages[i.bindId];r.id=i.id;r.element.id=i.id;r.statusDiv.style.backgroundImage="url(/images/delivered.png)";n.unconfirmedMessages[i.bindId]=undefined})},p=function(t){var i,u;n.isPanelOpened&&(i=f(t),r.setElement(t,i),i?n.unreadedMessages.push(t):(n.messages.push(t),n.readedMessagesOffset++),h(t));u=n.element.lastElementChild.lastElementChild;u.firstElementChild.innerText=t.text;u.lastElementChild.innerText=o.getDate(new Date(t.dateOfSending));s(n)};return{init:function(n,f,e,h,c,l){u=n;t=f;r=e;o=h;i=c;s=l;t.getMessageSendBtn().onclick=function(){y(g())}},setDialogContext:function(t){n=t},openDialog:function(){dialog.isPanelOpened||d();n.isPanelOpened=!0;n.messagesPanel.style.display="block";t.setDialog(n.title,n.status)},createDialog:v,createDialogs:function(n){for(var i=[],t=0;t<n.length;t++)i.push(v(n[t]));return i},addNewMessage:p,unreadedMessagesHandler:c,readedMessagesHandler:l,sendMessage:y,uploadUnreadedMessages:e,uploadReadedMessages:e}}(),dialogGuiModule=function(){var i,n,t,r,u;return{init:function(f){i=f;n=document.getElementById("conversationTitle");t=document.getElementById("conversationStatus");u=document.getElementById("messageTextBox");r=document.getElementById("messageSendBtn")},createDialogDiv:function(n){var t=document.createElement("div"),f,r,e,u,o,s;return t.classList.add("conversation"),t.id=n.id,f=document.createElement("div"),f.classList.add("conversationPhoto"),f.style.backgroundImage="url('/images/"+n.image+"')",r=document.createElement("div"),r.classList.add("conversationPreview"),e=document.createElement("div"),e.classList.add("conversationTitle"),e.innerText=n.title,u=document.createElement("div"),u.classList.add("conversationMessage"),o=document.createElement("div"),o.classList.add("conversationText"),o.innerText=n.lastMessageText!==null?n.lastMessageText:"",s=document.createElement("div"),s.classList.add("conversationDate"),s.innerText=n.lastMessageDate!==null?i.getDate(new Date(n.lastMessageDate)):"",u.appendChild(o),u.appendChild(s),r.appendChild(e),r.appendChild(u),t.appendChild(f),t.appendChild(r),t},getDialogTitleDiv:function(){return n},getDialogStatusDiv:function(){return t},getMessageText:function(){return u.value},getMessageSendBtn:function(){return r},setDialog:function(i,r){n.innerText=i;t.innerText=r}}}();class Dialog{constructor(n){this.id=n.id;this.title=n.title;this.lastMessageText=n.lastMessageText;this.lastMessageDate=n.lastMessageDate;this.image=n.image;this.interlocutorId=n.interlocutorId;this.isPanelOpened=!1;this.unreadedMessages=[];this.messages=[];this.unconfirmedMessages=[];this.readedMessagesOffset=0;this.allReadedUploaded=!1;this.allUnreadedUploaded=!1;this.uploadingBlocked=!1;this.uploadCount=20;this.messagesPanel=this.createMessagesPanel()}openDialog(){this.isPanelOpened||this.firstDialogMessagesUploading();this.isPanelOpened=!0;this.messagesPanel.style.display="block"}addNewMessage(n){var t,i;this.isPanelOpened&&(this.appendMessageToEnd(n),t=n.authorId===dialog.interlocutorId,n.CreateMessageElement(t),t?this.unreadedMessages.push(n):(this.messages.push(n),this.readedMessagesOffset++));i=this.element.lastElementChild.lastElementChild;i.firstElementChild.innerText=n.text;i.lastElementChild.innerText=GetDate(new Date(n.dateOfSending))}appendMessageToBegin(n){this.messagesPanel.prepend(n.element)}appendMessageToEnd(n){this.messagesPanel.appendChild(n.element)}}var messageModule=function(){var t=function(t,i){var r=document.createElement("div"),u,e,f;r.classList.add("messageBlock");r.id=t.id;u=document.createElement("div");u.classList.add("message");e=document.createElement("div");e.innerText=t.text;u.appendChild(e);i||(f=document.createElement("div"),f.classList.add("status"),u.appendChild(f),t.statusDiv=f,r.classList.add("authMes"),n(t));r.appendChild(u);t.element=r},i=function(t,i){t.status=i;n(t)},n=function(n){switch(status){case-1:n.statusDiv.style.backgroundImage="url(/images/notConfirmed.png)";break;case 0:n.statusDiv.style.backgroundImage="url(/images/delivered.png)";break;case 1:n.statusDiv.style.backgroundImage="url(/images/readed.png)"}},r=function(n,t){u(t)||(t=t.trim(),t=t.replace(/\s\s+/g," "),n.text=t)},u=function(n){return n===null||n.match(/^ *$/)!==null};return{init:function(){},setElement:t,setStatus:i,updateStatus:n,setText:r}}(),dialogsModule=function(){var t,u,n,i,r,f=function(){while(t.getDialogsContainer().firstChild)t.getDialogsContainer().firstChild.remove();i=[];r=1;n=null},e=function(n){n.element.onclick=function(){o(n)};t.getDialogsContainer().appendChild(n.element);t.getMessagesPanelsContainer().appendChild(n.messagesPanel);i.push(n)},o=function(t){(n===null||n.id!==t.id)&&(n!==null&&(n.messagesPanel.style.display="none"),u.setDialogContext(t),u.openDialog(),n=t)};return{init:function(f,e){t=f;u=e;n=null;i=[];r=1},getDialogById:function(n){return i.find(function(t){return t.id===n})},addDialog:e,removeDialogs:f,updateDialogs:function(n){f();for(var t=0;t<n.length;t++)e(n[t]);r++},getDialogByInterlocutorId:function(n){return i.find(function(t){return t.interlocutorId===n})},openDialog:o,isDialogUploaded:function(n){var t=getDialogByInterlocutorId(n);return t!==null&&t!==undefined},getDialogsStackNumber:function(){return r}}}(),dialogsGuiModule=function(){var n,r,t,i;return{init:function(){n=document.getElementById("dialogs");r=document.getElementById("panelsInner");t=document.getElementById("uploading");i=document.getElementById("dark")},getDialogsContainer:function(){return n},getMessagesPanelsContainer:function(){return r},getUploadingInfo:function(){return t},getDark:function(){return i},showUploading:function(){i.style.display="block";t.style.display="flex"},hideUploading:function(){i.style.display="none";t.style.display="none"},toTheTop:function(t){n.insertBefore(t.element,n.firstChild)}}}();class MaelstormRequest{constructor(n,t,i,r){this.url=n;this.handler=t;this.type=i===undefined?"GET":i;this.data=r}}var apiModule=function(){var i,r,u=function(){var n=localStorage.getItem("MAT"),t=localStorage.getItem("MRT");return n!==null&&t!==null&&n!==undefined&&t!==undefined&&n!==""&&t!==""},f=function(n){var t=new Date(n).getTime();localStorage.setItem("ATGT",t);r=t},e=function(){return(new Date).getTime()-r>3e5},n=function(n){e()?o(n):$.ajax({url:n.url,type:n.type,contentType:"application/json",dataType:"json",data:n.type==="POST"?JSON.stringify(n.data):null,beforeSend:function(n){var t=localStorage.getItem("MAT");t!==undefined&&n.setRequestHeader("Authorization","Bearer "+t)},success:function(t){n.handler(t)},statusCode:{401:function(t){t.getResponseHeader("Token-Expired")&&o(n)}}})},o=function(t){var o=localStorage.getItem("MAT"),s=localStorage.getItem("MRT"),r;u()&&e()&&(r=JSON.stringify({token:o,refreshtoken:s,fingerPrint:i}),$.ajax({url:"/api/authentication/rfrshtkn",type:"POST",contentType:"application/json",dataType:"json",data:r,success:function(i){if(i.isSuccessful){var r=JSON.parse(i.data);localStorage.setItem("MAT",r.AccessToken);localStorage.setItem("MRT",r.RefreshToken);f(r.GenerationTime);n(t)}else console.log("Token refreshing error: "+i.errorMessages.join(" ")),localStorage.removeItem("MAT"),localStorage.removeItem("MRT")}}))},t=function(n){return n===null||n.match(/^ *$/)!==null},s=function(){var i=window.navigator.userAgent,t=window.navigator.platform,n="Unknown";return["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(t)!==-1?n="Mac OS":["iPhone","iPad","iPod"].indexOf(t)!==-1?n="iOS":["Win32","Win64","Windows","WinCE"].indexOf(t)!==-1?n="Windows":/Android/.test(i)?n="Android":/Linux/.test(t)&&(n="Linux"),n},h=function(){var i=navigator.userAgent,t,n=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(i)||[],"IE "+(t[1]||"")):n[1]==="Chrome"&&(t=i.match(/\b(OPR|Edge)\/(\d+)/),t!=null)?t.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(t=i.match(/version\/(\d+)/i))!=null&&n.splice(1,1,t[1]),n.join(" "))};return{init:function(n){i=n;r=Number(localStorage.getItem("ATGT"))},areTokensValid:u,getDialogs:function(t,i){n(new MaelstormRequest("/api/dialog/getdialogs?stackNumber="+t,i))},getReadedMessages:function(t,i,r,u){n(new MaelstormRequest("/api/dialog/getReadedDialogMessages?dialogId="+t+"&offset="+i+"&count="+r,u,"GET"))},getUnreadedMessages:function(t,i,r){n(new MaelstormRequest("/api/dialog/getUnreadedDialogMessages?dialogId="+t+"&count="+i,r,"GET"))},sendDialogMessage:function(i,r){i.targetId!==0&&(t(i.text)||i.text.length>1&&i.text.length<4096&&n(new MaelstormRequest("/api/dialog/sendmessage",function(n){console.log(n);n.isSuccessful&&r(n)},"POST",i)))},login:function(n,t,r,u){var e={email:n,password:t,osCpu:s(),app:h(),fingerPrint:i};$.ajax({url:"/api/authentication/auth",type:"POST",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(n){if(n.isSuccessful){var t=JSON.parse(n.data);localStorage.setItem("MAT",t.AccessToken);localStorage.setItem("MRT",t.RefreshToken);f(t.GenerationTime);r()}else u()}})},registration:function(n,i,r,u,f,e){if(!t(n)&&!t(i)&&!t(r)&&!t(u)&&r===u){var o={nickname:n,email:i,password:r,confirmPassword:u};$.ajax({url:"/api/account/registration",type:"POST",contentType:"application/json",data:JSON.stringify(o),dataType:"json",success:function(n){n.isSuccessful?f():e(n)}})}},logOut:function(){n(new MaelstormRequest("/api/user/logout",null,"GET"));localStorage.clear()},getDialog:function(t,i){n(new MaelstormRequest("/api/dialog/getdialog?interlocutorId="+t,i))},getSessions:function(t){n(new MaelstormRequest("/api/user/getsessions",t,"GET"))},closeSession:function(t,i){var r={sessionId:t,banDevice:i};n(new MaelstormRequest("/api/user/closeSession",null,"POST",r))},getOnlineStatuses:function(t,i){t.length!==0&&n(new MaelstormRequest("/user/getonlinestatuses",i,"POST",t))}}}(),dateModule=function(){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sem","Okt","Nov","Dec"];return{getDate:function(t){var u=new Date,i="",r;return t.toDateString()!==u.toDateString()?t===u.getDate()-1?i="Tomorrow":(i=n[t.getMonth()]+" "+t.getDate(),t.getFullYear()!==u.getFullYear()&&(i+=" "+t.getFullYear())):(r=t.getMinutes().toString(),i=t.getHours()+":"+(r.length===2?r:"0"+r)),i}}}(),signalRModule=function(){var l="/messageHub",n,f,t,e,o,h,i,r,u,a=function(){n.invoke("Authorize",localStorage.getItem("MAT"),i)},s=function(){n!==null&&i!==""&&n.connectionState!==1?(y(),n.start().then(c).catch(function(){console.log("error on connecting");t+=1;t<f.length?setTimeout(()=>s(),f[t]):p()})):c()},v=function(){n.onclose(()=>{e||i===""||(console.log("lost connection"),s())});n.on("Ping",function(n){console.log("PONG, "+(n?"mister":"anonym"));console.log("Ping: "+((new Date).getMilliseconds()-o.getMilliseconds()))});n.on("RecieveMessage",function(n){var t=JSON.parse(n),i=new Message(t.id,t.dialogId,t.authorId,t.text,t.replyId,t.status,t.dateOfSending),u=r.getDialogById(i.dialogId);u!==undefined&&u!==null?u.addNewMessage(i):h.getDialog(i.authorId,function(n){r.addDialog(n);_dialog.addNewMessage(i)})});n.on("MessageWasReaded",function(n,t){var f=r.getDialogById(n),u,i;if(f!==undefined)for(u=f.messages,i=u.length;i>0;i--)if(u[i].id===t){SetAsReaded(u[i].element.firstChild);
//!!
console.log("man read: "+u[i].text);break}});n.on("OnHubAuthFalied",function(){alert("Auth failed")});n.on("OnSessionClosed",function(){localStorage.clear();e=!0;n.stop()})},c=function(){console.log("connected");t=-1;u.showConnected();a()},y=function(){console.log("connecting...");u.showConnecting()},p=function(){console.log("disconnected");u.showDisconnected()};return{init:function(s,c,a,y){h=s;i=c;r=a;u=y;f=[0,2e3,2e3,4e3,6e3];t=-1;e=!1;o=null;n=(new signalR.HubConnectionBuilder).withUrl(l).configureLogging(signalR.LogLevel.None).build();v()},startConnection:s,ping:function(){n.connectionState===1?(o=new Date,n.invoke("Ping")):console.log("Disconnected")}}}(),connectionGuiModule=function(){var n,t,i,r=function(){n.style.display="none";t.style.display="none"};return{init:function(){n=document.getElementById("connecting");t=document.getElementById("connected");i=document.getElementById("disconnected")},showConnecting:function(){n.style.display="flex"},hideConnectInfo:r,showConnected:function(){t.style.display="flex";n.style.display="none";setTimeout(function(){t.style.display="none"},2500)},showDisconnected:function(){r();i.style.display="flex"}}}(),accountGui=accountGuiModule,account=accountModule,loginForm=loginFormModule,regForm=registrationFormModule,dialogs=dialogsModule,dialog=dialogModule,message=messageModule,dialogsGui=dialogsGuiModule,dialogGui=dialogGuiModule,date=dateModule,api=apiModule,signalRConnection=signalRModule,connectionGui=connectionGuiModule;main();