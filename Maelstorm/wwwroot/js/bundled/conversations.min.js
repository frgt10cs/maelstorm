function init(){dialogGui.showUploading();api.getDialogs(dialog.getDialogsStackNumber(),n=>{dialog.updateDialogs(n),dialogGui.hideUploading()})}function initModules(n){api.init(n);accountGui.init(loginForm,regForm);account.init(api,accountGui);dialogGui.init();dialog.init(dialogGui)}function main(){Fingerprint2.get(function(n){var t=n.map(function(n){return n.value}),i=Fingerprint2.x64hash128(t.join(""),31);initModules(i);api.areTokensValid()?init():accountGui.openLogin()})}var accountModule=function(){var t,n,i=function(){n.getLoginForm().isDataValid()&&t.login(n.getLoginForm().getLogin(),n.getLoginForm().getPassword(),()=>{n.onLogin(),n.hideAllForms()},()=>{onLoginFailed(),alert("Login failed")})},r=function(){n.regForm.isDataValid()&&t.registration(n.regForm.login,n.getRegForm().getEmail(),n.getRegForm().getPassword(),n.getRegForm.getPasswordConfirm(),()=>{onRegistration()},n=>{onRegistrationFailed(n)})},u=function(){t.logOut();n.openLogin()};return{init:function(f,e){t=f;n=e;n.getLoginForm().getSubmitButton().onclick=i;n.getRegForm().getSubmitButton().onclick=r;n.getLogoutBtn().onclick=u}}}(),loginFormModule=function(){var n,t,i,r;return{init:function(){n=document.getElementById("loginForm");t=document.getElementById("login");i=document.getElementById("password");r=document.getElementById("loginBtn")},getLogin:function(){return t.value},getPassword:function(){return i.value},getSubmitButton:function(){return r},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),registrationFormModule=function(){var n,t,i,r,u,f;return{init:function(){n=document.getElementById("regForm");t=document.getElementById("regLogin");i=document.getElementById("regEmail");r=document.getElementById("regPassword");u=document.getElementById("regPasswordConfirm");f=document.getElementById("regBtn")},getLogin:function(){return t.value},getEmail:function(){return i.value},getPassword:function(){return r.value},getPasswordConfirm:function(){return u.value},getSubmitButton:function(){return f},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),accountGuiModule=function(){var n,t,r,u,f,i,e=function(){i.style.display="block";n.hide();t.open()},o=function(){i.style.display="block";t.hide();n.open()};return{getLoginForm:function(){return n},getRegForm:function(){return t},getLogoutBtn:function(){return r},openLogin:o,openRegistration:e,hideAllForms:function(){i.style.display="none";n.hide();t.hide()},init:function(s,h){u=document.getElementById("openLogin");u.onclick=function(){o()};f=document.getElementById("openReg");f.onclick=function(){e()};r=document.getElementById("logoutButton");i=document.getElementById("dark");n=s;n.init();t=h;t.init()}}}(),dialogModule,dialogGuiModule;class Dialog{constructor(n){this.id=n.id;this.title=n.title;this.lastMessageText=n.lastMessageText;this.lastMessageDate=n.lastMessageDate;this.image=n.image;this.interlocutorId=n.interlocutorId;this.isPanelOpened=!1;this.unreadedMessages=[];this.messages=[];this.unconfirmedMessages=[];this.readedMessagesOffset=0;this.allReadedUploaded=!1;this.allUnreadedUploaded=!1;this.messagesPanel=this.CreateMessagesPanel();this.element=this.CreateDialogDiv(this);this.uploadingBlocked=!1}CreateMessagesPanel(){var n=document.createElement("div");return n.classList.add("conversationMessages"),n.style.display="none",n.onscroll=function(){this.OnMessagesPanelScroll()},n}OnMessagesPanelScroll(){this.uploadingBlocked||(this.messagesPanel.scrollTop<10&&!this.allReadedUpload?(console.log("old upl"),this.uploadingBlocked=!0,this.UploadReadedMessages()):this.messagesPanel.scrollHeight-this.messagesPanel.scrollTop-this.messagesPanel.offsetHeight<10&&!this.allUnreadedUpload&&this.unreadedMessages.length===0&&(console.log("new upl"),this.uploadingBlocked=!0,this.UploadUnreadedMessages()))}Open(){this.isPanelOpened=!0;this.messagesPanel.style.display="block"}Close(){this.messagesPanel.style.display="none"}SendMessage(n){var t=this.unconfirmedMessages.length;n.dateOfSending=new Date;n.status=-1;n.bindId=t;SendDialogMessage(n,n=>{var t=JSON.parse(n.data),i=unconfirmedMessages[t.bindId];i.id=t.id;i.element.id=t.id;i.statusDiv.style.backgroundImage="url(/images/delivered.png)";unconfirmedMessages[t.bindId]=undefined});unconfirmedMessages.push(n);this.AddNewMessage(n)}UnreadedMessagesHandler(n){if(n!==null&&n!==undefined&&n.length>0){n.length<uploadMessagesCount&&(this.allUnreadedUpload=!0);for(var t=0;t<n.length;t++)this.AppendMessageToEnd(n[t]),this.unreadedMessages.push(n[t])}else this.allUnreadedUpload=!0;this.uploadingBlocked=!1}ReadedMessagesHandler(n){var i,t;if(n!==null&&n!==undefined&&n.length>0){for(n.length<uploadMessagesCount&&(this.allReadedUpload=!0),this.readedMessagesOffset+=n.length,i=0,t=0;t<n.length;t++)this.AppendMessageToBegin(n[t]),this.messages.unshift(n[t]),i+=n[t].element.offsetHeight;this.messagesPanel.scrollTop=i}else this.allReadedUpload=!0;this.uploadingBlocked=!1}FirstMessagesUpload(){this.UploadReadedMessages()}UploadReadedMessages(){GetReadedMessages(dialog.id,dialog.readedMessagesOffset,uploadMessagesCount,this.ReadedMessagesHandler)}UploadUnreadedMessages(){GetUnreadedMessages(dialog.id,uploadMessagesCount,this.UnreadedMessagesHandler)}AddNewMessage(n){var t,i;this.isPanelOpened&&(this.AppendMessageToEnd(n),t=n.authorId===this.interlocutorId,n.CreateMessageElement(t),t?dialog.unreadedMessages.push(n):(dialog.messages.push(n),dialog.readedMessagesOffset++));i=dialog.element.lastElementChild.lastElementChild;i.firstElementChild.innerText=n.text;i.lastElementChild.innerText=GetDate(new Date(n.dateOfSending));dialogsContainer.insertBefore(dialog.element,dialogsContainer.firstChild)}AppendMessageToBegin(n){this.messagesPanel.prepend(n.element)}AppendMessageToEnd(n){this.messagesPanel.appendChild(n.element)}}dialogModule=function(){var t,o,n,i,r,u,f=function(){while(t.getDialogsContainer().firstChild)t.getDialogsContainer().firstChild.remove();i=[];r=1;n=null},s=function(n){var t=document.createElement("div"),u,i,f,r,e,o;return t.classList.add("conversation"),t.id=n.id,t.onclick=function(){openDialog(n)},u=document.createElement("div"),u.classList.add("conversationPhoto"),u.style.backgroundImage="url('/images/"+n.image+"')",i=document.createElement("div"),i.classList.add("conversationPreview"),f=document.createElement("div"),f.classList.add("conversationTitle"),f.innerText=n.title,r=document.createElement("div"),r.classList.add("conversationMessage"),e=document.createElement("div"),e.classList.add("conversationText"),e.innerText=n.lastMessageText!==null?n.lastMessageText:"",o=document.createElement("div"),o.classList.add("conversationDate"),o.innerText=n.lastMessageDate!==null?getDate(new Date(n.lastMessageDate)):"",r.appendChild(e),r.appendChild(o),i.appendChild(f),i.appendChild(r),t.appendChild(u),t.appendChild(i),t},e=function(n){var r=new Dialog(n);t.getDialogsContainer().appendChild(r.element);u.appendChild(r.messagesPanel);i.push(r)};return{init:function(f,e){t=f;o=e;n=null;i=[];r=1;u=[]},getDialogById:function(n){return i.find(function(t){return t.id===n})},addDialog:e,removeDialogs:f,updateDialogs:function(n){f();for(var t=0;t<n.length;t++)e(n[t]);r++},getDialogByInterlocutorId:function(n){return i.find(function(t){return t.interlocutorId===n})},openDialog:function(i){(n===null||n.id!==i.id)&&(n!==null&&n.Close(),i.isPanelOpened||firstDialogMessagesUploading(i),t.setDialog(i.title,i.status),i.Open(),n=i)},isDialogUploaded:function(n){var t=getDialogByInterlocutorId(n);return t!==null&&t!==undefined},createDialogDiv:s,getDialogsStackNumber:function(){return r}}}();dialogGuiModule=function(){var u,i,r,f,n,e,o,t;return{init:function(){u=document.getElementById("dialogs");i=document.getElementById("conversationTitle");r=document.getElementById("conversationStatus");f=document.getElementById("panelsInner");n=document.getElementById("uploading");e=document.getElementById("mesInput");o=document.getElementById("mesSendBut");t=document.getElementById("dark")},getDialogsContainer:function(){return u},getDialogTitleDiv:function(){return i},getDialogStatusDiv:function(){return r},getMessagesPanelsContainer:function(){return f},getUploadingInfo:function(){return n},getMessageBox:function(){return e},getMesSendBut:function(){return o},getDark:function(){return t},setDialog:function(n,t){i.innerText=n;r.innerText=t},showUploading:function(){t.style.display="block";n.style.display="flex"},hideUploading:function(){t.style.display="none";n.style.display="none"}}}();class MaelstormRequest{constructor(n,t,i,r){this.url=n;this.handler=t;this.type=i===undefined?"GET":i;this.data=r}}var apiModule=function(){var i,r,u=function(){var n=localStorage.getItem("MAT"),t=localStorage.getItem("MRT");return n!==null&&t!==null&&n!==undefined&&t!==undefined&&n!==""&&t!==""},f=function(n){var t=new Date(n).getTime();localStorage.setItem("ATGT",t);r=t},e=function(){return(new Date).getTime()-r>3e5},n=function(n){e()?o(n):$.ajax({url:n.url,type:n.type,contentType:"application/json",dataType:"json",data:n.type==="POST"?JSON.stringify(n.data):null,beforeSend:function(n){var t=localStorage.getItem("MAT");t!==undefined&&n.setRequestHeader("Authorization","Bearer "+t)},success:function(t){n.handler(t)},statusCode:{401:function(t){t.getResponseHeader("Token-Expired")&&o(n)}}})},o=function(t){var o=localStorage.getItem("MAT"),s=localStorage.getItem("MRT"),r;u()&&e()&&(r=JSON.stringify({token:o,refreshtoken:s,fingerPrint:i}),$.ajax({url:"/api/authentication/rfrshtkn",type:"POST",contentType:"application/json",dataType:"json",data:r,success:function(i){if(i.isSuccessful){var r=JSON.parse(i.data);localStorage.setItem("MAT",r.AccessToken);localStorage.setItem("MRT",r.RefreshToken);f(r.GenerationTime);n(t)}else console.log("Token refreshing error: "+i.errorMessages.join(" ")),localStorage.removeItem("MAT"),localStorage.removeItem("MRT")}}))},t=function(n){return n===null||n.match(/^ *$/)!==null},s=function(){var i=window.navigator.userAgent,t=window.navigator.platform,n="Unknown";return["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(t)!==-1?n="Mac OS":["iPhone","iPad","iPod"].indexOf(t)!==-1?n="iOS":["Win32","Win64","Windows","WinCE"].indexOf(t)!==-1?n="Windows":/Android/.test(i)?n="Android":/Linux/.test(t)&&(n="Linux"),n},h=function(){var i=navigator.userAgent,t,n=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(i)||[],"IE "+(t[1]||"")):n[1]==="Chrome"&&(t=i.match(/\b(OPR|Edge)\/(\d+)/),t!=null)?t.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(t=i.match(/version\/(\d+)/i))!=null&&n.splice(1,1,t[1]),n.join(" "))};return{init:function(n){i=n;r=Number(localStorage.getItem("ATGT"))},areTokensValid:u,getDialogs:function(t,i){n(new MaelstormRequest("/api/dialog/getdialogs?stackNumber="+t,i))},getReadedMessages:function(t,i,r,u){n(new MaelstormRequest("/api/dialog/getReadedDialogMessages?dialogId="+t+"&offset="+i+"&count="+r,u,"GET"))},getUnreadedMessages:function(t,i,r){n(new MaelstormRequest("/api/dialog/getUnreadedDialogMessages?dialogId="+t+"&count="+i,r,"GET"))},sendDialogMessage:function(i,r){i.targetId!==0&&(t(i.text)||i.text.length>1&&i.text.length<4096&&n(new MaelstormRequest("/api/dialog/sendmessage",function(n){console.log(n);n.isSuccessful&&r(n)},"POST",i)))},login:function(n,t,r,u){var e={email:n,password:t,osCpu:s(),app:h(),fingerPrint:i};$.ajax({url:"/api/authentication/auth",type:"POST",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(n){if(n.isSuccessful){var t=JSON.parse(n.data);localStorage.setItem("MAT",t.AccessToken);localStorage.setItem("MRT",t.RefreshToken);f(t.GenerationTime);r()}else u()}})},registration:function(n,i,r,u,f,e){if(!t(n)&&!t(i)&&!t(r)&&!t(u)&&r===u){var o={nickname:n,email:i,password:r,confirmPassword:u};$.ajax({url:"/api/account/registration",type:"POST",contentType:"application/json",data:JSON.stringify(o),dataType:"json",success:function(n){n.isSuccessful?f():e(n)}})}},logOut:function(){n(new MaelstormRequest("/api/user/logout",null,"GET"));localStorage.clear()},getDialog:function(t,i){n(new MaelstormRequest("/api/dialog/getdialog?interlocutorId="+t,i))},getSessions:function(t){n(new MaelstormRequest("/api/user/getsessions",t,"GET"))},closeSession:function(t,i){var r={sessionId:t,banDevice:i};n(new MaelstormRequest("/api/user/closeSession",null,"POST",r))},getOnlineStatuses:function(t,i){t.length!==0&&n(new MaelstormRequest("/user/getonlinestatuses",i,"POST",t))}}}(),accountGui=accountGuiModule,account=accountModule,loginForm=loginFormModule,regForm=registrationFormModule,dialog=dialogModule,dialogGui=dialogGuiModule,api=apiModule;main();