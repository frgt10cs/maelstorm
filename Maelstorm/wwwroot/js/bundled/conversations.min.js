function init(){dialogGui.showUploading();api.getDialogs(dialogs.getDialogsStackNumber(),n=>{dialogs.updateDialogs(dialog.createDialogs(n)),dialogGui.hideUploading()})}function initModules(n){api.init(n);accountGui.init(loginForm,regForm);account.init(api,accountGui);dialogGui.init();dialog.init(api,date,50,dialogGui.toTheTop);dialogs.init(dialogGui)}function main(){Fingerprint2.get(function(n){var t=n.map(function(n){return n.value}),i=Fingerprint2.x64hash128(t.join(""),31);initModules(i);api.areTokensValid()?init():accountGui.openLogin()})}var accountModule=function(){var t,n,i=function(){n.getLoginForm().isDataValid()&&t.login(n.getLoginForm().getLogin(),n.getLoginForm().getPassword(),()=>{n.onLogin(),n.hideAllForms()},()=>{onLoginFailed(),alert("Login failed")})},r=function(){n.regForm.isDataValid()&&t.registration(n.regForm.login,n.getRegForm().getEmail(),n.getRegForm().getPassword(),n.getRegForm.getPasswordConfirm(),()=>{onRegistration()},n=>{onRegistrationFailed(n)})},u=function(){t.logOut();n.openLogin()};return{init:function(f,e){t=f;n=e;n.getLoginForm().getSubmitButton().onclick=i;n.getRegForm().getSubmitButton().onclick=r;n.getLogoutBtn().onclick=u}}}(),loginFormModule=function(){var n,t,i,r;return{init:function(){n=document.getElementById("loginForm");t=document.getElementById("login");i=document.getElementById("password");r=document.getElementById("loginBtn")},getLogin:function(){return t.value},getPassword:function(){return i.value},getSubmitButton:function(){return r},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),registrationFormModule=function(){var n,t,i,r,u,f;return{init:function(){n=document.getElementById("regForm");t=document.getElementById("regLogin");i=document.getElementById("regEmail");r=document.getElementById("regPassword");u=document.getElementById("regPasswordConfirm");f=document.getElementById("regBtn")},getLogin:function(){return t.value},getEmail:function(){return i.value},getPassword:function(){return r.value},getPasswordConfirm:function(){return u.value},getSubmitButton:function(){return f},hide:function(){n.style.display="none"},open:function(){n.style.display="block"},isDataValid:function(){return!0}}}(),accountGuiModule=function(){var n,t,r,u,f,i,e=function(){i.style.display="block";n.hide();t.open()},o=function(){i.style.display="block";t.hide();n.open()};return{getLoginForm:function(){return n},getRegForm:function(){return t},getLogoutBtn:function(){return r},openLogin:o,openRegistration:e,hideAllForms:function(){i.style.display="none";n.hide();t.hide()},init:function(s,h){u=document.getElementById("openLogin");u.onclick=function(){o()};f=document.getElementById("openReg");f.onclick=function(){e()};r=document.getElementById("logoutButton");i=document.getElementById("dark");n=s;n.init();t=h;t.init()}}}(),dialogModule=function(){var i,t,f,n,e,h=function(n){var t=document.createElement("div"),u,i,f,r,o,s;return t.classList.add("conversation"),t.id=n.id,t.onclick=function(){},u=document.createElement("div"),u.classList.add("conversationPhoto"),u.style.backgroundImage="url('/images/"+n.image+"')",i=document.createElement("div"),i.classList.add("conversationPreview"),f=document.createElement("div"),f.classList.add("conversationTitle"),f.innerText=n.title,r=document.createElement("div"),r.classList.add("conversationMessage"),o=document.createElement("div"),o.classList.add("conversationText"),o.innerText=n.lastMessageText!==null?n.lastMessageText:"",s=document.createElement("div"),s.classList.add("conversationDate"),s.innerText=n.lastMessageDate!==null?e.getDate(new Date(n.lastMessageDate)):"",r.appendChild(o),r.appendChild(s),i.appendChild(f),i.appendChild(r),t.appendChild(u),t.appendChild(i),t},o=function(t){n.messagesPanel.prepend(t.element)},r=function(t){n.messagesPanel.appendChild(t.element)},c=function(){var n=document.createElement("div");return n.classList.add("conversationMessages"),n.style.display="none",n.onscroll=function(){l()},n},l=function(){n.uploadingBlocked||(thdialogContextis.messagesPanel.scrollTop<10&&!n.allReadedUpload?(console.log("old upl"),n.uploadingBlocked=!0,y()):n.messagesPanel.scrollHeight-n.messagesPanel.scrollTop-this.messagesPanel.offsetHeight<10&&!n.allUnreadedUpload&&n.unreadedMessages.length===0&&(console.log("new upl"),n.uploadingBlocked=!0,u()))},a=function(i){if(i!==null&&i!==undefined&&i.length>0){i.length<t&&(n.allUnreadedUpload=!0);for(var u=0;u<i.length;u++)r(i[u]),n.unreadedMessages.push(i[u])}else n.allUnreadedUpload=!0;n.uploadingBlocked=!1},v=function(i){var u,r;if(i!==null&&i!==undefined&&i.length>0){for(i.length<t&&(n.allReadedUpload=!0),n.readedMessagesOffset+=i.length,u=0,r=0;r<i.length;r++)o(i[r]),n.messages.unshift(i[r]),u+=i[r].element.offsetHeight;n.messagesPanel.scrollTop=u}else n.allReadedUpload=!0;n.uploadingBlocked=!1},u=function(){i.getUnreadedMessages(n.id,uploadCount,a)},y=function(){i.getReadedMessages(n.id,n.readedMessagesOffset,uploadCount,v)},s=function(n){var t={};return t.id=n.id,t.title=n.title,t.lastMessageText=n.lastMessageText,t.lastMessageDate=n.lastMessageDate,t.image=n.image,t.interlocutorId=n.interlocutorId,t.isPanelOpened=!1,t.unreadedMessages=[],t.messages=[],t.unconfirmedMessages=[],t.readedMessagesOffset=0,t.allReadedUploaded=!1,t.allUnreadedUploaded=!1,t.uploadingBlocked=!1,t.messagesPanel=c(),t.element=h(t),t};return{init:function(n,r,u,o){i=n;e=r;t=u;f=o},setDialogContext:function(t){n=t},createDialog:s,createDialogs:function(n){for(var i=[],t=0;t<n.length;t++)i.push(s(n[t]));return i},addNewMessage:function(t){var i,u;n.isPanelOpened&&(r(t),i=t.authorId===dialog.interlocutorId,t.CreateMessageElement(i),i?n.unreadedMessages.push(t):(n.messages.push(t),n.readedMessagesOffset++));u=n.element.lastElementChild.lastElementChild;u.firstElementChild.innerText=t.text;u.lastElementChild.innerText=GetDate(new Date(t.dateOfSending));f()},unreadedMessagesHandler:function(i){if(i!==null&&i!==undefined&&i.length>0){i.length<t&&(n.allUnreadedUpload=!0);for(var u=0;u<i.length;u++)r(i[u]),n.unreadedMessages.push(i[u])}else n.allUnreadedUpload=!0;n.uploadingBlocked=!1},readedMessagesHandler:function(i){var u,r;if(i!==null&&i!==undefined&&i.length>0){for(i.length<t&&(n.allReadedUpload=!0),n.readedMessagesOffset+=i.length,u=0,r=0;r<i.length;r++)o(i[r]),n.messages.unshift(i[r]),u+=i[r].element.offsetHeight;n.messagesPanel.scrollTop=u}else n.allReadedUpload=!0;n.uploadingBlocked=!1},sendMessage:function(t){var i=n.unconfirmedMessages.length;t.dateOfSending=new Date;t.status=-1;t.bindId=i;SendDialogMessage(t,t=>{var i=JSON.parse(t.data),r=n.unconfirmedMessages[i.bindId];r.id=i.id;r.element.id=i.id;r.statusDiv.style.backgroundImage="url(/images/delivered.png)";unconfirmedMessages[i.bindId]=undefined});n.unconfirmedMessages.push(t);n.addNewMessage(t)},uploadUnreadedMessages:u,uploadReadedMessages:u}}(),dialogsModule=function(){var t,n,i,r,u=function(){while(t.getDialogsContainer().firstChild)t.getDialogsContainer().firstChild.remove();i=[];r=1;n=null},f=function(n){t.getDialogsContainer().appendChild(n.element);t.getMessagesPanelsContainer().appendChild(n.messagesPanel);i.push(n)};return{init:function(u){t=u;n=null;i=[];r=1},getDialogById:function(n){return i.find(function(t){return t.id===n})},addDialog:f,removeDialogs:u,updateDialogs:function(n){u();for(var t=0;t<n.length;t++)f(n[t]);r++},getDialogByInterlocutorId:function(n){return i.find(function(t){return t.interlocutorId===n})},openDialog:function(i){(n===null||n.id!==i.id)&&(n!==null&&(n.messagesPanel.style.display="none"),i.isPanelOpened||firstDialogMessagesUploading(i),t.setDialog(i.title,i.status),i.isPanelOpened=!0,i.messagesPanel.style.display="block",n=i)},isDialogUploaded:function(n){var t=getDialogByInterlocutorId(n);return t!==null&&t!==undefined},getDialogsStackNumber:function(){return r}}}(),dialogGuiModule=function(){var n,r,u,f,t,e,o,i;return{init:function(){n=document.getElementById("dialogs");r=document.getElementById("conversationTitle");u=document.getElementById("conversationStatus");f=document.getElementById("panelsInner");t=document.getElementById("uploading");e=document.getElementById("mesInput");o=document.getElementById("mesSendBut");i=document.getElementById("dark")},getDialogsContainer:function(){return n},getDialogTitleDiv:function(){return r},getDialogStatusDiv:function(){return u},getMessagesPanelsContainer:function(){return f},getUploadingInfo:function(){return t},getMessageBox:function(){return e},getMesSendBut:function(){return o},getDark:function(){return i},setDialog:function(n,t){r.innerText=n;u.innerText=t},showUploading:function(){i.style.display="block";t.style.display="flex"},hideUploading:function(){i.style.display="none";t.style.display="none"},toTheTop:function(t){n.insertBefore(t.element,n.firstChild)}}}();class MaelstormRequest{constructor(n,t,i,r){this.url=n;this.handler=t;this.type=i===undefined?"GET":i;this.data=r}}var apiModule=function(){var i,r,u=function(){var n=localStorage.getItem("MAT"),t=localStorage.getItem("MRT");return n!==null&&t!==null&&n!==undefined&&t!==undefined&&n!==""&&t!==""},f=function(n){var t=new Date(n).getTime();localStorage.setItem("ATGT",t);r=t},e=function(){return(new Date).getTime()-r>3e5},n=function(n){e()?o(n):$.ajax({url:n.url,type:n.type,contentType:"application/json",dataType:"json",data:n.type==="POST"?JSON.stringify(n.data):null,beforeSend:function(n){var t=localStorage.getItem("MAT");t!==undefined&&n.setRequestHeader("Authorization","Bearer "+t)},success:function(t){n.handler(t)},statusCode:{401:function(t){t.getResponseHeader("Token-Expired")&&o(n)}}})},o=function(t){var o=localStorage.getItem("MAT"),s=localStorage.getItem("MRT"),r;u()&&e()&&(r=JSON.stringify({token:o,refreshtoken:s,fingerPrint:i}),$.ajax({url:"/api/authentication/rfrshtkn",type:"POST",contentType:"application/json",dataType:"json",data:r,success:function(i){if(i.isSuccessful){var r=JSON.parse(i.data);localStorage.setItem("MAT",r.AccessToken);localStorage.setItem("MRT",r.RefreshToken);f(r.GenerationTime);n(t)}else console.log("Token refreshing error: "+i.errorMessages.join(" ")),localStorage.removeItem("MAT"),localStorage.removeItem("MRT")}}))},t=function(n){return n===null||n.match(/^ *$/)!==null},s=function(){var i=window.navigator.userAgent,t=window.navigator.platform,n="Unknown";return["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(t)!==-1?n="Mac OS":["iPhone","iPad","iPod"].indexOf(t)!==-1?n="iOS":["Win32","Win64","Windows","WinCE"].indexOf(t)!==-1?n="Windows":/Android/.test(i)?n="Android":/Linux/.test(t)&&(n="Linux"),n},h=function(){var i=navigator.userAgent,t,n=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(i)||[],"IE "+(t[1]||"")):n[1]==="Chrome"&&(t=i.match(/\b(OPR|Edge)\/(\d+)/),t!=null)?t.slice(1).join(" ").replace("OPR","Opera"):(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(t=i.match(/version\/(\d+)/i))!=null&&n.splice(1,1,t[1]),n.join(" "))};return{init:function(n){i=n;r=Number(localStorage.getItem("ATGT"))},areTokensValid:u,getDialogs:function(t,i){n(new MaelstormRequest("/api/dialog/getdialogs?stackNumber="+t,i))},getReadedMessages:function(t,i,r,u){n(new MaelstormRequest("/api/dialog/getReadedDialogMessages?dialogId="+t+"&offset="+i+"&count="+r,u,"GET"))},getUnreadedMessages:function(t,i,r){n(new MaelstormRequest("/api/dialog/getUnreadedDialogMessages?dialogId="+t+"&count="+i,r,"GET"))},sendDialogMessage:function(i,r){i.targetId!==0&&(t(i.text)||i.text.length>1&&i.text.length<4096&&n(new MaelstormRequest("/api/dialog/sendmessage",function(n){console.log(n);n.isSuccessful&&r(n)},"POST",i)))},login:function(n,t,r,u){var e={email:n,password:t,osCpu:s(),app:h(),fingerPrint:i};$.ajax({url:"/api/authentication/auth",type:"POST",contentType:"application/json",data:JSON.stringify(e),dataType:"json",success:function(n){if(n.isSuccessful){var t=JSON.parse(n.data);localStorage.setItem("MAT",t.AccessToken);localStorage.setItem("MRT",t.RefreshToken);f(t.GenerationTime);r()}else u()}})},registration:function(n,i,r,u,f,e){if(!t(n)&&!t(i)&&!t(r)&&!t(u)&&r===u){var o={nickname:n,email:i,password:r,confirmPassword:u};$.ajax({url:"/api/account/registration",type:"POST",contentType:"application/json",data:JSON.stringify(o),dataType:"json",success:function(n){n.isSuccessful?f():e(n)}})}},logOut:function(){n(new MaelstormRequest("/api/user/logout",null,"GET"));localStorage.clear()},getDialog:function(t,i){n(new MaelstormRequest("/api/dialog/getdialog?interlocutorId="+t,i))},getSessions:function(t){n(new MaelstormRequest("/api/user/getsessions",t,"GET"))},closeSession:function(t,i){var r={sessionId:t,banDevice:i};n(new MaelstormRequest("/api/user/closeSession",null,"POST",r))},getOnlineStatuses:function(t,i){t.length!==0&&n(new MaelstormRequest("/user/getonlinestatuses",i,"POST",t))}}}(),dateModule=function(){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sem","Okt","Nov","Dec"];return{getDate:function(t){var u=new Date,i="",r;return t.toDateString()!==u.toDateString()?t===u.getDate()-1?i="Tomorrow":(i=n[t.getMonth()]+" "+t.getDate(),t.getFullYear()!==u.getFullYear()&&(i+=" "+t.getFullYear())):(r=t.getMinutes().toString(),i=t.getHours()+":"+(r.length===2?r:"0"+r)),i}}}(),accountGui=accountGuiModule,account=accountModule,loginForm=loginFormModule,regForm=registrationFormModule,dialogs=dialogsModule,dialog=dialogModule,dialogGui=dialogGuiModule,date=dateModule,api=apiModule;main();